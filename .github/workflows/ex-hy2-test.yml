name: Process Proxy Subscription via URL

on:
  repository_dispatch:
    types: [check-updates]

jobs:
  process-subscription:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Get subscription content
        run: |
          # æ›¿æ¢ä¸ºæ‚¨çš„è®¢é˜…é“¾æ¥
          SUB_URL="https://example.com/subscription.b64"
          curl -sL -o subscription.b64 "$SUB_URL"
          
          # ä½¿ç”¨ Python è§£ç ç¡®ä¿å…¼å®¹æ€§
          python -c "import base64; open('external_decoded.txt', 'wb').write(base64.b64decode(open('subscription.b64', 'rb').read()))"
          
          if [ ! -s external_decoded.txt ]; then
            echo "âŒ è®¢é˜…å†…å®¹è§£ç å¤±è´¥"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Filter and re-encode
        run: |
          mkdir -p proxies
          python - <<EOF
          import base64

          with open('external_decoded.txt', 'r') as f:
              content = f.read()

          filtered = '\n'.join(
              line for line in content.splitlines()
              if not line.strip().lower().startswith('hysteria2://')
          )

          with open('proxies/encoded.txt', 'w') as f:
              f.write(base64.b64encode(filtered.encode()).decode())
          EOF

      - name: Commit changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add proxies/encoded.txt
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä»£ç†è®¢é˜… [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "âš ï¸ æ— å†…å®¹å˜æ›´"
          fi
